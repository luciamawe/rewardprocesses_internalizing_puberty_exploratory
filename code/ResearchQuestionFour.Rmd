---
title: "Research Question 4: Do neural and self-reported responses to reward moderate the relationship between pubertal development and internalizing symptoms?"
date: "August 2020"
output:
  html_document: default
  pdf_document: default
authors: Natalie Saragosa-Harris 
---
``` {r loadPackages, echo = FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(gamm4)
library(dplyr)
library(sjPlot)
library(here)
library(jtools)
library(interactions)
library(gamm4.test)
```

```{r setdirectories, echo = FALSE}
# Covariates.
#      Random effects.
#           1. Family. (rel_family_id) # Make sure this is nested correctly and looks about right.
#           2. Site. (site_id_l)
#           3. Subject. (src_subject_id) # There is only one timepoint so we cannot do a random effect for each participant.
#           4. Device. # mri_info_deviceserialnumber.

          #  Random effects are nested: (1|abcd_site/device/rel_family_id) [unless some siblings went in different scanners?]

#      Fixed effects.
#           1. Race parent. (race.eth.5level).
#           2. Education parent. (high.educ).
#           3. Income parent. (household.income)
#           4. Marital status parent. (married.or.livingtogether)
#           5. Age. (interview_age).
#           6. Hispanic. (demo_race_hispanic).
#           7. Maternal Depression (Yes/No). (fam_history_q6d_depression). This is specific to the mother; do we want to use the one about the family history in general? Many cases are missing, we will not include in main model
```
```{r}
#LMW alternative to read in the data

data_dir = ((dirname(here()))) #figure out how to navigate to data source

phase_folder = "exploratory"  #select the appropiate folder
#phase_folder = "confirmatory"  #select the appropiate folder

data_folder <- file.path(data_dir,"ABCD","derivatives",phase_folder)  

file_name <- "nda20_exploratory.csv" #specify file name here 

fulldata <- read.csv(file.path(data_folder,file_name))
```

```{r GetData, echo = FALSE}
length(fulldata$src_subject_id) # 5934.
data <- fulldata[,c("src_subject_id",
                "interview_age",
                "eventname",
                "sex",
                "site_id_l",
                "mri_info_deviceserialnumber",
                "rel_family_id",
                "race.ethnicity.5level",
                "race.eth.7level",
                "demo_race_hispanic", # Do you consider the child Hispanic/Latino/Latina?
                "high.educ",
                "household.income",
                "married.or.livingtogether",
                "cbcl_scr_syn_internal_t",
                "cbcl_scr_syn_anxdep_t",
                "cbcl_scr_syn_withdep_t",
                "cbcl_scr_dsm5_depress_t",
                "cbcl_scr_syn_internal_r",
                "cbcl_scr_syn_anxdep_r",
                "cbcl_scr_syn_withdep_r",
                "cbcl_scr_dsm5_depress_r",
                "PDS_score_f",
                "PDS_score_m",
                "PDS_score",
                "PDS_sum_f",
                "PDS_sum_m",
                "PDS_sum",
                "pds_p_ss_category",
                "fam_history_q6d_depression",
                "tfmri_ma_acdn_b_scs_aarh", # Accumbens reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_aalh",
                "tfmri_ma_acdn_b_scs_cdrh", # Caudate reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_cdlh",
                "tfmri_ma_acdn_b_scs_ptrh", # Putamen reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_ptlh",
                "tfmri_ma_arvn_b_cds_mobofrrh", # Medial OFC reward vs. neutral anticipation.
                "tfmri_ma_arvn_b_cds_mobofrlh",
                "tfmri_ma_arvn_b_cds_lobofrrh", # Lateral OFC reward vs. neutral anticipation.
                "tfmri_ma_arvn_b_cds_lobofrlh",
                "tfmri_ma_rpvnfb_b_scs_aarh", # Accumbens reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_aalh",
                "tfmri_ma_rpvnfb_b_scs_cdrh", # Caudate reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_cdlh",
                "tfmri_ma_rpvnfb_b_scs_ptrh", # Putamen reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_ptlh",
                "tfmri_ma_rpvnfb_b_cds_mobofrrh", # Medial OFC reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_cds_mobofrlh",
                "tfmri_ma_rpvnfb_b_cds_lobofrrh", # Lateral OFC reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_cds_lobofrlh",
                "accumbens_rvsn_ant_z", # Reward vs. neutral during anticipation stage (z scores).
                "caudate_rvsn_ant_z",
                "putamen_rvsn_ant_z",
                "mOFC_rvsn_ant_z",
                "lOFC_rvsn_ant_z",
                "striatum_rvsn_ant_z", # reward vs. neutral anticipation.
                "accumbens_posvsneg_feedback_z", # All positive vs. negative feedback.
                "caudate_posvsneg_feedback_z",
                "putamen_posvsneg_feedback_z",
                "mOFC_posvsneg_feedback_z",
                "lOFC_posvsneg_feedback_z",
                "striatum_posvsneg_feedback_z"
                )]
data$src_subject_id <- as.factor(data$src_subject_id)
data$rel_family_id <- as.factor(data$rel_family_id)
data$eventname <- as.factor(data$eventname)
data$sex <- as.factor(data$sex)
data$demo_race_hispanic <- as.factor(data$demo_race_hispanic)
data$site_id_l <- as.factor(data$site_id_l)
data$mri_info_deviceserialnumber <- as.factor(data$mri_info_deviceserialnumber)
data$race.eth.7level <- as.factor(data$race.eth.7level)
data$high.educ <- as.factor(data$high.educ)
data$household.income <- as.factor(data$household.income)
data$married.or.livingtogether <- as.factor(data$married.or.livingtogether)
data$pds_p_ss_category <-as.factor(data$pds_p_ss_category)
data$race.ethnicity.5level = data$race.eth.7level
data$race.ethnicity.5level[(data$race.eth.7level == "AIAN" | data$race.eth.7level == "NHPI")] = "Other"
data$race.ethnicity.5level = droplevels(data$race.ethnicity.5level)
data$PDS_score_z<- scale(data$PDS_score)
data$cbcl_scr_syn_internal_r_z <- scale(data$cbcl_scr_syn_internal_r)
length(data$src_subject_id) # 5934.

# Use data with only correct PDS scores.
PDS_correct <- subset(data, PDS_score < 5) #Be mindful that PDS category goes from 1 to 5, while PDS_average goes from 1 to 4 (continuous).
length(PDS_correct$src_subject_id) # 4224.

# Separate by sex.
PDS_correct_females <- subset(PDS_correct, sex == "F") # 2059.
PDS_correct_males <- subset(PDS_correct, sex == "M") # 2165.
length(PDS_correct_females$src_subject_id)
length(PDS_correct_males$src_subject_id)

# Create different subsets of the data based on removing outliers for specific variables of interest.

# No CBCL outliers.
data_no_CBCL_outliers <- subset(PDS_correct, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers$src_subject_id) # 4152.
data_no_CBCL_outliers_females<- subset(PDS_correct_females, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers_females$src_subject_id) # 2026.
data_no_CBCL_outliers_males<- subset(PDS_correct_males, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers_males$src_subject_id) # 2126.

# No striatal anticipation outliers.
data_no_striatal_ant_outliers <- subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers$src_subject_id) # 4169.
data_no_striatal_ant_outliers_females <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers_females$src_subject_id) # 2035.
data_no_striatal_ant_outliers_males <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers_males$src_subject_id) # 2134.

# No CBCL or striatal anticipation outliers.
data_no_CBCL_striatal_ant_outliers <- subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers$src_subject_id) # 4097.
data_no_CBCL_striatal_ant_outliers_females <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers_females$src_subject_id) # 2002.
data_no_CBCL_striatal_ant_outliers_males <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers_males$src_subject_id) # 2095.

# Pubertal
data_no_CBCL_striatal_ant_outliers_females_pubertal <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3 & pds_p_ss_category != 1)
length(data_no_CBCL_striatal_ant_outliers_females_pubertal$src_subject_id) #1380
data_no_CBCL_striatal_ant_outliers_males_pubertal <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3 &  pds_p_ss_category != 1)
length(data_no_CBCL_striatal_ant_outliers_males_pubertal$src_subject_id) #583

```

# Confirmatory Hypothesis 4: We predict that striatal responses to reward will moderate the effect of pubertal stage such that the relationship between advanced pubertal status and internalizing symptoms will be stronger among participants with attenuated activation in striatal reward circuitry during reward anticipation.

#Basic data checks and transformations
```{r Confirmatory4, echo = FALSE}
# Use combined score for accumbens, caudate, and putamen?
# Jen: I would probably run the 3 separately and control for multiple comparisons. If the three give you highly correlated results you could take a composite measure for subsequent analyses.
cor.test(data$accumbens_rvsn_ant_z,data$caudate_rvsn_ant_z) # 0.64.
cor.test(data$accumbens_rvsn_ant_z,data$putamen_rvsn_ant_z) # 0.63.
cor.test(data$caudate_rvsn_ant_z,data$putamen_rvsn_ant_z) # 0.851. 

#Explore outliers
boxplot(data$accumbens_rvsn_ant_z)
boxplot(data$caudate_rvsn_ant_z)
boxplot(data$putamen_rvsn_ant_z)
boxplot(data$cbcl_scr_syn_internal_r)
```
#Count NAs per variable 
```{r}
#Count NAs per variable 
# We are missing many cases of maternal depression - consider dropping
dataformodel <- data_no_CBCL_striatal_ant_outliers 

sum(is.na(dataformodel$src_subject_id)) #0 missing  
sum(is.na(dataformodel$sex))  #0 missing   
sum(is.na(dataformodel$mri_info_deviceserialnumber)) #0 missing 
sum(is.na(dataformodel$rel_family_id)) #0 missing 
sum(is.na(dataformodel$race.ethnicity.5level)) #41
sum(is.na(dataformodel$demo_race_hispanic))  #50
sum(is.na(dataformodel$high.educ))  #3
sum(is.na(dataformodel$household.income)) #293
sum(is.na(dataformodel$married.or.livingtogether))  #22
sum(is.na(dataformodel$fam_history_q6d_depression)) #1937 missing!

summary(dataformodel)

#Also, some brain variables seem to have large outliers. Check before including in the models 
```

##  Model: CBCL internalizing factor ~ PDS*Striatal activity (anticipation stage)
##  N o
```{r Confirmatory4, echo = FALSE}
# Composite striatum score, exlcuding outliers.
# No CBCL exclusions
# With covariates

dataformodel <- data_no_striatal_ant_outliers  #Specify data subset here

confirmatory4_compositestriatum <- lmer(cbcl_scr_syn_internal_r ~ 
                                           PDS_score
                                        #*striatum_rvsn_ant_z +
                            #race.ethnicity.5level +
                            #demo_race_hispanic +
                            #high.educ +
                            #household.income +
                            #married.or.livingtogether +
                            #interview_age+
                            #fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),
                            dataformodel)
summary(confirmatory4_compositestriatum)

plot_model(confirmatory4_compositestriatum,type = "pred", show.data = TRUE) #Interaction plot

plot_model(confirmatory4_compositestriatum,type = "est", show.data = TRUE) #Forest plot

#p <- plot_model(confirmatory4_compositestriatum,type = "int", terms = "PDS_score",            show.data = TRUE, jitter = 0.1, line.size = 2) +

#file.name = (here("output","question4_exploratory.tiff"))
#ggsave(file.name,plot = last_plot(), dpi = 150, device = "tiff")

#p <- ggplot( data = subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3), aes(x=sex, y=striatum_rvsn_ant_z)) + 
#  geom_boxplot()
#p
```

# Core model (no covariates)
```{r}
# Core model (no covariates)
# Composite striatum score.
# Excluding CBCL outliers 
# Without covariates

dataformodel <- data_no_CBCL_striatal_ant_outliers

#Select only cases that have complete data for all covariates of intest. It seems that we are missing many cases of maternal depression. We might drop it going forwards. 
tempdata <- dataformodel[which(complete.cases(dataformodel[,c("race.ethnicity.5level",
                            "demo_race_hispanic",
                            "high.educ",
                            "household.income",
                            "married.or.livingtogether",
                            "interview_age"
                            )])),]
nrow(dataformodel)
nrow(tempdata)

confirmatory4_compositestriatum_excludingoutliers_core <- lmer(cbcl_scr_syn_internal_r ~
                                           PDS_score *striatum_rvsn_ant_z+ sex +
                            (1 | site_id_l/rel_family_id),
                            data = tempdata)

summary(confirmatory4_compositestriatum_excludingoutliers_core)

print.gamtest(confirmatory4_compositestriatum_excludingoutliers_core,2)

plot_model(confirmatory4_compositestriatum_excludingoutliers_core,type = "int", show.data = FALSE, show.p = TRUE) #Interaction plot

plot_model(confirmatory4_compositestriatum_excludingoutliers_core,type = "std", show.data = FALSE) #Forest plot

# p <- plot_model(confirmatory4_compositestriatum_excludingoutliers_core,
#                 type = "pred", # To specify values for striatal response, have to use "pred" instead.
#                 terms = c("PDS_score","striatum_rvsn_ant_z [-2.0,0,2.0]"),
#                 show.data = TRUE, jitter = 0.1, line.size = 2) +
#                 ylab("Internalizing Score") +
#                 xlab("Average PDS score") +
#                 labs(colour = "MID Striatal activity z-score \n (reward anticipation vs neutral)")+
#                 scale_y_continuous(breaks = seq(0, 45, by = 10), limits = c(0,45)) +
#                 theme(title= element_text(size=20, vjust=2, face="bold"),
#                 plot.title = element_blank(),
#                 axis.title.x= element_text(size=18, vjust=-0.3),
#                 axis.title.y= element_text(size=18, vjust=1.5),
#                 axis.text.x= element_text(size=18, colour="black"),
#                 axis.text.y= element_text(size=18, colour="black"),
#                 legend.title=element_text(size=12, colour = "black"),
#                 legend.position = c(.80, .80),
#                 # legend.position="none",
#                 strip.text = element_text(size=18, face="bold"),
#                 panel.background = element_blank(),
#                 axis.line = element_line(colour = "black"))
# p 

```

```{r}
#Excluding outliers in CBCL 
#Reveals main effect of striatum as well as interaction, but in the opposite way?

dataformodel<- data_no_CBCL_striatal_ant_outliers_males
dataformodel<-data_no_CBCL_striatal_ant_outliers_females_pubertal

#Select only cases that have complete data for all covariates of intest. It seems that we are missing many cases of maternal depression. We might drop it going forwards. 
tempdata <- dataformodel[which(complete.cases(dataformodel[,c("race.ethnicity.5level",
                            "demo_race_hispanic",
                            "high.educ",
                            "household.income",
                            "married.or.livingtogether",
                            "interview_age"
                            )])),]

confirmatory4_compositestriatum_excludingoutliers <- lme4::lmer(cbcl_scr_syn_internal_r ~ 
                            pds_p_ss_category*
                            striatum_rvsn_ant_z+
                            race.ethnicity.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age+
                          #  fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),  #same thing as site is the same thing as (1|site) + (1|family:site), this is what done in paper by Paulus et al. (2019), 22 sites 
#data = subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3))
data = tempdata)
summary(confirmatory4_compositestriatum_excludingoutliers)


mod <- gamm4(cbcl_scr_syn_internal_r ~ 
                            PDS_score_z^2+
                            striatum_rvsn_ant_z+
                            #sex+
                            race.ethnicity.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age, data=dataformodel, random = ~ (1 | site_id_l/rel_family_id),family=gaussian())

plot_model(mod$mer,type = "est", show.data = FALSE, show.p = TRUE) #Interaction plot


print(mod$gam)
print(summary(mod))

summary(mod$gam)

vis.gam(mod$gam)

summary(confirmatory4_compositestriatum_excludingoutliers)
gam.grptest(confirmatory4_compositestriatum_excludingoutliers)

```

```{r}
#Quick plots
plot_model(confirmatory4_compositestriatum_excludingoutliers,type = "int", show.data = FALSE) #Interaction plot

plot_model(confirmatory4_compositestriatum_excludingoutliers,type = "std", show.data = FALSE) #Forest plot with standarized coefficients
```

```{r}
#Compare model with and without covariates - adding covariates makes the model significantly improve
anova(confirmatory4_compositestriatum_excludingoutliers_core,confirmatory4_compositestriatum_excludingoutliers)
```

```{r}
#Publication plot
#Both sexes

p <- plot_model(confirmatory4_compositestriatum_excludingoutliers,
                type = "pred", # To specify values for striatal response, have to use "pred" instead.
                terms = c("PDS_score","striatum_rvsn_ant_z [-2.0,0,2.0]"),
                show.data = TRUE, jitter = 0.1, line.size = 2) +
                ylab("Internalizing Score") +
                xlab("Average PDS score") +
                labs(colour = "MID Striatal activity z-score \n (reward anticipation vs neutral)")+
                scale_y_continuous(breaks = seq(0, 45, by = 10), limits = c(0,45)) +
                theme(title= element_text(size=20, vjust=2, face="bold"),
                plot.title = element_blank(),
                axis.title.x= element_text(size=18, vjust=-0.3),
                axis.title.y= element_text(size=18, vjust=1.5),
                axis.text.x= element_text(size=18, colour="black"),
                axis.text.y= element_text(size=18, colour="black"),
                legend.title=element_text(size=12, colour = "black"),
                legend.position = c(.80, .80),
                # legend.position="none",
                strip.text = element_text(size=18, face="bold"),
                panel.background = element_blank(),
                axis.line = element_line(colour = "black"))
p 
                 
file.name = (here("output","question4_exploratory_excludingCBCLoutliers.tiff"))
#ggsave(file.name,plot = last_plot(), dpi = 150, device = "tiff")
```

# Excluding outliers in CBCL 
## Splitting by sex
## FEMALES
```{r}
# Excluding outliers in CBCL 
# Splitting by sex
# FEMALES

dataformodel <- data_no_CBCL_striatal_ant_outliers_females

confirmatory4_compositestriatum_excludingoutliers_femalesonly <- lmer(cbcl_scr_syn_internal_r ~ 
                            PDS_score*striatum_rvsn_ant_z +
                            race.ethnicity.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age+
                            #fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),
                            dataformodel)

summary(PDS_correct_females$interview_age)
summary(confirmatory4_compositestriatum_excludingoutliers_femalesonly)
```
```{r}
#Quick plots
plot_model(confirmatory4_compositestriatum_excludingoutliers_femalesonly,type = "pred", terms = c("PDS_score","striatum_rvsn_ant_z [-2.0,0,2.0]"),show.data = FALSE) #Interaction plot

plot_model(confirmatory4_compositestriatum_excludingoutliers_femalesonly, type= "std",how.data = FALSE) #Forest plot with standardized coefficients
```

```{r}
# Excluding outliers in CBCL 
# Splitting by sex
# MALES

dataformodel <- data_no_CBCL_striatal_ant_outliers_males

confirmatory4_compositestriatum_excludingoutliers_malesonly <- lmer(cbcl_scr_syn_internal_r ~ 
                            PDS_score*striatum_rvsn_ant_z +
                            race.ethnicity.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age+
                            #fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),
                            dataformodel)

summary(confirmatory4_compositestriatum_excludingoutliers_malesonly)
```
```{r}
#Quick plots
plot_model(confirmatory4_compositestriatum_excludingoutliers_malesonly,type = "pred", terms = c("PDS_score","striatum_rvsn_ant_z [-2.0,0,2.0]"),show.data = FALSE) #Interaction plot

plot_model(confirmatory4_compositestriatum_excludingoutliers_malesonly,type = "std", show.data = FALSE) #Forest plot with standarized coefficients
```


```{r}
#Excluding outliers in CBCL 
#PDS category 

confirmatory4_compositestriatum_excludingoutliers_cat <- lmer(cbcl_scr_syn_internal_r ~                                       pds_p_ss_category*striatum_rvsn_ant_z +
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age+
                            fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),
                            data = subset(PDS_correct, 
                                          striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3))

summary(confirmatory4_compositestriatum_excludingoutliers_cat)

plot_model(confirmatory4_compositestriatum_excludingoutliers_cat,type = "int", show.data = FALSE) #Interaction plot

plot_model(confirmatory4_compositestriatum_excludingoutliers,type = "est", show.data = FALSE) #Forest plot

p <- plot_model(confirmatory4_compositestriatum_excludingoutliers_cat,
                type = "pred", # To specify values for striatal response, have to use "pred" instead.
                terms = c("pds_p_ss_category","striatum_rvsn_ant_z [-2.0,0,2.0]"),
                show.data = TRUE, jitter = 0.1, line.size = 2) +
                ylab("Internalizing Score") +
                xlab("PDS category") +
                labs(colour = "MID Striatal activity z-score \n (reward anticipation vs neutral)")+
                scale_y_continuous(breaks = seq(0, 45, by = 10), limits = c(0,45)) +
                theme(title= element_text(size=20, vjust=2, face="bold"),
                plot.title = element_blank(),
                axis.title.x= element_text(size=18, vjust=-0.3),
                axis.title.y= element_text(size=18, vjust=1.5),
                axis.text.x= element_text(size=18, colour="black"),
                axis.text.y= element_text(size=18, colour="black"),
                legend.title=element_text(size=12, colour = "black"),
                legend.position = c(.80, .80),
                # legend.position="none",
                strip.text = element_text(size=18, face="bold"),
                panel.background = element_blank(),
                axis.line = element_line(colour = "black"))
p 
                   
file.name = (here("output","question4_exploratory_excludingCBCLoutliers_PDScat.tiff"))
ggsave(file.name,plot = last_plot(), dpi = 150, device = "tiff")

```



```{r}
#Quickly checking whether reward is associated with pubertal development
#This needs to be moved to the another script
exploratory_compositestriatum_puberty <- lmer(striatum_rvsn_ant_z ~ 
                                           PDS_score +
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age+
                            fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),
                            data = subset(PDS_correct, 
                                          striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3))
summary(exploratory_compositestriatum_puberty )

plot_model(confirmatory4_compositestriatum_excludingoutliers,type = "int", show.data = FALSE) #Interaction plot

plot_model(exploratory_compositestriatum_puberty,type = "est", show.data = FALSE) #Forest plot

p <- plot_model(exploratory_compositestriatum_puberty,type,
                type = "pred", # To specify values for striatal response, have to use "pred" instead.
                terms = c("PDS_score"),
                show.data = TRUE, jitter = 0.1, line.size = 2) +
                ylab("MID Striatal activity z-score \n (reward anticipation vs neutral)") +
                xlab("Average PDS score") +
                #labs(colour = "MID Striatal activity z-score \n (reward anticipation vs neutral)")+
                #scale_y_continuous(breaks = seq(0, 45, by = 10), limits = c(0,45)) +
                theme(title= element_text(size=20, vjust=2, face="bold"),
                plot.title = element_blank(),
                axis.title.x= element_text(size=18, vjust=-0.3),
                axis.title.y= element_text(size=18, vjust=1.5),
                axis.text.x= element_text(size=18, colour="black"),
                axis.text.y= element_text(size=18, colour="black"),
                legend.title=element_text(size=12, colour = "black"),
                legend.position = c(.80, .80),
                # legend.position="none",
                strip.text = element_text(size=18, face="bold"),
                panel.background = element_blank(),
                axis.line = element_line(colour = "black"))
p 
                   
                   
                   

file.name = (here("output","striatum_puberty.tiff"))
#ggsave(file.name,plot = last_plot(), dpi = 150, device = "tiff")

```


# Exploratory Hypothesis 4A: We will investigate whether striatal responses to reward during reward feedback moderates the effect of pubertal stage on internalizing symptoms. 
## Model: CBCL internalizing factor ~ PDS*Striatal activity (feedback stage)
```{r Exploratory4A, echo = FALSE}

# Separate analyses first.
exploratory4A_accumbens<- lm(cbcl_scr_syn_internal_t ~ PDS_score*accumbens_posvsneg_feedback + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age,
                            data = PDS_correct)
summary(exploratory4A_accumbens)

exploratory4A_caudate<- lm(cbcl_scr_syn_internal_t ~ PDS_score*caudate_posvsneg_feedback + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age,
                            data = PDS_correct)
summary(exploratory4A_caudate)

exploratory4A_putamen<- lm(cbcl_scr_syn_internal_t ~ PDS_score*putamen_posvsneg_feedback + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age,
                            data = PDS_correct)
summary(exploratory4A_putamen)

# Composite striatum score.
exploratory4A_compositestriatum <- lm(cbcl_scr_syn_internal_t ~ PDS_score*striatum_posvsneg_feedback + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age,
                            data = PDS_correct)
summary(exploratory4A_compositestriatum)

```


```{r Exploratory4A, echo = FALSE}
#Excluding outliers in CBCL 
#Reveals main effect of striatum as well as interaction, but in the opposite way?

#Excluding outliers in CBCL 
#Reveals main effect of striatum as well as interaction, but in the opposite way?
exploratory4_compositestriatum_excludingoutliers <- lmer(cbcl_scr_syn_internal_r ~                                        PDS_score*striatum_posvsneg_feedback_z +
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age+
                            fam_history_q6d_depression + #added mother's depression
                            (1 | site_id_l/rel_family_id),
                            data = subset(PDS_correct, 
                                          striatum_posvsneg_feedback_z > -3 & striatum_posvsneg_feedback_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3))
summary(exploratory4_compositestriatum_excludingoutliers)

plot_model(exploratory4_compositestriatum_excludingoutliers,type = "int", show.data = FALSE) #Interaction plot

plot_model(exploratory4_compositestriatum_excludingoutliers,type = "est", show.data = FALSE) #Forest plot

p <- plot_model(exploratory4_compositestriatum_excludingoutliers,
                type = "pred", # To specify values for striatal response, have to use "pred" instead.
                terms = c("PDS_score","striatum_posvsneg_feedback_z [-2.0,0,2.0]"),
                show.data = TRUE, jitter = 0.1, line.size = 2) +
                ylab("Internalizing Score") +
                xlab("Average PDS score") +
                labs(colour = "MID Striatal activity z-score \n (reward anticipation vs neutral)")+
                scale_y_continuous(breaks = seq(0, 45, by = 10), limits = c(0,45)) +
                theme(title= element_text(size=20, vjust=2, face="bold"),
                plot.title = element_blank(),
                axis.title.x= element_text(size=18, vjust=-0.3),
                axis.title.y= element_text(size=18, vjust=1.5),
                axis.text.x= element_text(size=18, colour="black"),
                axis.text.y= element_text(size=18, colour="black"),
                legend.title=element_text(size=12, colour = "black"),
                legend.position = c(.80, .80),
                # legend.position="none",
                strip.text = element_text(size=18, face="bold"),
                panel.background = element_blank(),
                axis.line = element_line(colour = "black"))
p 
                   
                   
                   

file.name = (here("output","question4_exploratory_excludingCBCLoutliers.tiff"))
#ggsave(file.name,plot = last_plot(), dpi = 150, device = "tiff")

boxplot(PDS_correct$PDS_score)
```




```{r Confirmatory4, echo = FALSE}
# Separate analyses first.
confirmatory4_accumbens <- lm(cbcl_scr_syn_internal_t ~ PDS_score*accumbens_rvsn_ant + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age, 
                            data = subset(PDS_correct, 
                                          accumbens_rvsn_ant_z > -3 & accumbens_rvsn_ant_z < 3))
summary(confirmatory4_accumbens)


confirmatory4_caudate <- lm(cbcl_scr_syn_internal_t ~ PDS_score*caudate_rvsn_ant_z + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age, 
                           data = subset(PDS_correct, 
                                          caudate_rvsn_ant_z > -3 & caudate_rvsn_ant_z < 3))
summary(confirmatory4_caudate)


confirmatory4_putamen <- lm(cbcl_scr_syn_internal_t ~ PDS_score*putamen_rvsn_ant_z + 
                            race.eth.5level +
                            demo_race_hispanic +
                            high.educ +
                            household.income +
                            married.or.livingtogether +
                            interview_age, 
                            data = subset(PDS_correct, 
                                          putamen_rvsn_ant_z > -3 & putamen_rvsn_ant_z < 3))
summary(confirmatory4_putamen)
```










# Exploratory Hypothesis 4B: We will investigate whether OFC activation during reward anticipation and feedback moderates the relationship between pubertal stage and internalizing symptoms.
## Model A: CBCL internalizing factor ~ PDS*OFC activity (anticipation stage)
## Model B: CBCL internalizing factor ~ PDS*OFC activity (feedback stage)

```{r Exploratory4B, echo = FALSE}


```

# Exploratory Hypothesis 4C: We hypothesize that the association between advanced puberty and internalizing symptoms will be moderated by self-reported reward responsiveness. We predict that advanced puberty will be associated with higher internalizing in individuals who report lower reward responsiveness on the BIS-BAS questionnaire.
## Model: CBCL internalizing factor ~ PDS*BIS-BAS
```{r Exploratory4C, echo = FALSE}


```

# Exploratory Hypothesis 4D: We hypothesize that the association between advanced puberty and internalizing symptoms will be moderated by behavioral reward responsiveness (i.e., MID reaction time). We predict that advanced puberty will be associated with higher internalizing in individuals who demonstrate lower behavioral reward responsiveness.
## Model: CBCL internalizing factor ~ PDS*MID reaction time
```{r Exploratory4D, echo = FALSE}


```

# Exploratory Hypothesis 4E: We will investigate whether testosterone, and its relationship with reward, relates to internalizing symptoms, while controlling for PDS.
## Model A: CBCL internalizing factor ~ Testosterone*Striatal activity (anticipation stage) + PDS
## Model B: CBCL internalizing factor ~ Testosterone*Striatal activity (feedback stage) + PDS
## Model C: CBCL internalizing factor ~ Testosterone*OFC activity (anticipation stage) + PDS
## Model D: CBCL internalizing factor ~ Testosterone*OFC activity (feedback stage) + PDS
## Model E: CBCL internalizing factor ~ Testosterone*BIS-BAS RR
## Model F: CBCL internalizing factor ~ Testosterone*MID Reaction Time
```{r Exploratory4E, echo = FALSE}


```