---
title: "Research Question 2: Does pubertal development relate to internalizing symptoms?"
date: "August 2020"
output:
  html_document: default
  pdf_document: default
authors: Natalie Saragosa-Harris 
---
``` {r loadPackages, echo = FALSE, message=FALSE, warning=FALSE}
#install.packages("here")


library(ggplot2)
library(gamm4)
library(dplyr)
library(sjPlot)
library(lmerTest)


```

```{r setdirectories, echo = FALSE}
# Change this to your directory and the name of your data file.
datapath <- "~/GitHub/ABCD/derivatives/exploratory/"
datafile <- "nda20_exploratory.csv"


# Covariates.
#      Random effects.
#           1. Family. (rel_family_id) # Make sure this is nested correctly and looks about right.
#           2. Site. (site_id_l)
#           3. Subject. (src_subject_id) # There is only one timepoint so we cannot do a random effect for each participant.
#           4. Device. # mri_info_deviceserialnumber.

          #  Random effects are nested: (1|abcd_site/device/rel_family_id) [unless some siblings went in different scanners?]

#      Fixed effects.
#           1. Race parent. (race.ethnicity.5level).
#           2. Education parent. (high.educ).
#           3. Income parent. (household.income)
#           4. Marital status parent. (married.or.livingtogether)
#           5. Age. (interview_age).
#           6. Hispanic. (demo_race_hispanic).
#           7. Maternal Depression (Yes/No). (fam_history_q6d_depression). This is specific to the mother; do we want
#              to use the one about the family history in general?

```

```{r}
#Read in data. Choose your the adequate data_folder line and comment out the other

here() #this function will set the directory to .../rewardprocesses_internalizing_puberty_exploratory and should work in everyone's computer

data_dir = ((dirname(here()))) #move one folder up from /rewardprocesses_internalizing_puberty_exploratory, function here should work regardless of path

phase_folder = "exploratory"  #select the appropiate folder
#phase_folder = "confirmatory"  #select the appropiate folder

data_folder <- file.path(data_dir,"ABCD","derivatives",phase_folder)  #LMW
#data_folder <- file.path(data_dir,"ABCD","output")  #NSH, #EM

file_name <- "nda20_exploratory.csv" #specify file name here 

fulldata <- read.csv(file.path(data_folder,file_name))



```



```{r GetData, echo = FALSE}
#LMW alternative to read in the data
data_dir = ((dirname(here())))
phase_folder = "exploratory"  #select the appropiate folder
#phase_folder = "confirmatory"  #select the appropiate folder
data_folder <- file.path(data_dir,"ABCD","derivatives",phase_folder)
file_name <- "nda20_exploratory.csv" #specify file name here
fulldata <- read.csv(file.path(data_folder,file_name))
length(fulldata$src_subject_id) # 5934.
data <- fulldata[,c("src_subject_id",
                "interview_age",
                "eventname",
                "sex",
                "site_id_l",
                "mri_info_deviceserialnumber",
                "rel_family_id",
                "race.ethnicity.5level",
                "race.eth.7level",
                "demo_race_hispanic", # Do you consider the child Hispanic/Latino/Latina?
                "high.educ",
                "household.income",
                "married.or.livingtogether",
                "cbcl_scr_syn_internal_t",
                "cbcl_scr_syn_anxdep_t",
                "cbcl_scr_syn_withdep_t",
                "cbcl_scr_dsm5_depress_t",
                "cbcl_scr_syn_internal_r",
                "cbcl_scr_syn_anxdep_r",
                "cbcl_scr_syn_withdep_r",
                "cbcl_scr_dsm5_depress_r",
                "PDS_score_f",
                "PDS_score_m",
                "PDS_score",
                "PDS_sum_f",
                "PDS_sum_m",
                "PDS_sum",
                "pds_p_ss_category",
                "fam_history_q6d_depression",
                "tfmri_ma_acdn_b_scs_aarh", # Accumbens reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_aalh",
                "tfmri_ma_acdn_b_scs_cdrh", # Caudate reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_cdlh",
                "tfmri_ma_acdn_b_scs_ptrh", # Putamen reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_ptlh",
                "tfmri_ma_arvn_b_cds_mobofrrh", # Medial OFC reward vs. neutral anticipation.
                "tfmri_ma_arvn_b_cds_mobofrlh",
                "tfmri_ma_arvn_b_cds_lobofrrh", # Lateral OFC reward vs. neutral anticipation.
                "tfmri_ma_arvn_b_cds_lobofrlh",
                "tfmri_ma_rpvnfb_b_scs_aarh", # Accumbens reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_aalh",
                "tfmri_ma_rpvnfb_b_scs_cdrh", # Caudate reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_cdlh",
                "tfmri_ma_rpvnfb_b_scs_ptrh", # Putamen reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_ptlh",
                "tfmri_ma_rpvnfb_b_cds_mobofrrh", # Medial OFC reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_cds_mobofrlh",
                "tfmri_ma_rpvnfb_b_cds_lobofrrh", # Lateral OFC reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_cds_lobofrlh",
                "accumbens_rvsn_ant_z", # Reward vs. neutral during anticipation stage (z scores).
                "caudate_rvsn_ant_z",
                "putamen_rvsn_ant_z",
                "mOFC_rvsn_ant_z",
                "lOFC_rvsn_ant_z",
                "striatum_rvsn_ant_z", # reward vs. neutral anticipation.
                "accumbens_posvsneg_feedback_z", # All positive vs. negative feedback.
                "caudate_posvsneg_feedback_z",
                "putamen_posvsneg_feedback_z",
                "mOFC_posvsneg_feedback_z",
                "lOFC_posvsneg_feedback_z",
                "striatum_posvsneg_feedback_z",
                "hormone_scr_ert_mean" #TESTOSTERONE MEAN 
                )]


data$src_subject_id <- as.factor(data$src_subject_id)
data$rel_family_id <- as.factor(data$rel_family_id)
data$eventname <- as.factor(data$eventname)
data$sex <- as.factor(data$sex)
data$demo_race_hispanic <- as.factor(data$demo_race_hispanic)
data$site_id_l <- as.factor(data$site_id_l)
data$mri_info_deviceserialnumber <- as.factor(data$mri_info_deviceserialnumber)
data$race.eth.7level <- as.factor(data$race.eth.7level)
data$high.educ <- as.factor(data$high.educ)
data$household.income <- as.factor(data$household.income)
data$married.or.livingtogether <- as.factor(data$married.or.livingtogether)
data$pds_p_ss_category <-as.factor(data$pds_p_ss_category)
data$race.ethnicity.5level = data$race.eth.7level
data$race.ethnicity.5level[(data$race.eth.7level == "AIAN" | data$race.eth.7level == "NHPI")] = "Other"
data$race.ethnicity.5level = droplevels(data$race.ethnicity.5level)
data$PDS_score_z<- scale(data$PDS_score)
data$cbcl_scr_syn_internal_r_z <- scale(data$cbcl_scr_syn_internal_r)
data$hormone_scr_ert_mean_z <- scale(data$hormone_scr_ert_mean)
length(data$src_subject_id) # 5934.
# Use data with only correct PDS scores.
PDS_correct <- subset(data, PDS_score < 5) #Be mindful that PDS category goes from 1 to 5, while PDS_average goes from 1 to 4 (continuous).
length(PDS_correct$src_subject_id) # 4224.

# Separate by sex.
PDS_correct_females <- subset(PDS_correct, sex == "F") # 2059.
PDS_correct_males <- subset(PDS_correct, sex == "M") # 2165.
length(PDS_correct_females$src_subject_id)
length(PDS_correct_males$src_subject_id)
# Create different subsets of the data based on removing outliers for specific variables of interest.

# No CBCL outliers.
data_no_CBCL_outliers <- subset(PDS_correct, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers$src_subject_id) # 4152.

data_no_CBCL_outliers_females<- subset(PDS_correct_females, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers_females$src_subject_id) # 2026.

data_no_CBCL_outliers_males<- subset(PDS_correct_males, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers_males$src_subject_id) # 2126.

# No striatal anticipation outliers.
data_no_striatal_ant_outliers <- subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers$src_subject_id) # 4169.
data_no_striatal_ant_outliers_females <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers_females$src_subject_id) # 2035.
data_no_striatal_ant_outliers_males <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers_males$src_subject_id) # 2134.

# No CBCL or striatal anticipation outliers.
data_no_CBCL_striatal_ant_outliers <- subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers$src_subject_id) # 4097.
data_no_CBCL_striatal_ant_outliers_females <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers_females$src_subject_id) # 2002.
data_no_CBCL_striatal_ant_outliers_males <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers_males$src_subject_id) # 2095.
```

# Are there general gender differences in CBCL scores?
```{r CBCLDescriptives, echo = FALSE}
# Use data with only correct PDS scores.
#Excluding CBCL outliers
PDS_correct <- data_no_CBCL_outliers
females <- data_no_CBCL_outliers_females
males <- data_no_CBCL_outliers_males

# Get an idea of the sample.

mean(PDS_correct$cbcl_scr_syn_internal_r,na.rm= TRUE) # 5.00.
mean(females$cbcl_scr_syn_internal_r,na.rm= TRUE) # 4.97
mean(males$cbcl_scr_syn_internal_r,na.rm= TRUE) # 5.03.
min(females$cbcl_scr_syn_internal_r,na.rm= TRUE) # 0.
min(males$cbcl_scr_syn_internal_r,na.rm= TRUE) # 30.
t.test(males$cbcl_scr_syn_internal_r,females$cbcl_scr_syn_internal_r) # Not significant.


```

# Confirmatory Hypothesis 2: We hypothesize that advanced pubertal stage will be associated with higher internalizing symptoms as measured by the Child Behavior Checklist (CBCL) internalizing factor (Ullsperger & Nikolas, 2017).
## Model: CBCL internalizing factor ~ Pubertal stage
```{r Confirmatory2, echo = FALSE}
#Excluding CBCL outliers
confirmatory2 <- lmer(cbcl_scr_syn_internal_r ~ PDS_score +
                      race.ethnicity.5level +
                      high.educ +
                      household.income +
                      married.or.livingtogether +
                      interview_age +
                      demo_race_hispanic +
                      (1 | site_id_l/rel_family_id),
                      data = PDS_correct)
summary(confirmatory2)
# (1 | site_id_l/mri_info_deviceserialnumber/rel_family_id)
# (1 | mri_info_deviceserialnumber/rel_family_id)


# predicteddata <- get_model_data(confirmatory2,type = "pred", terms = "PDS_score")

#geom_segment(aes(x = -4, xend = 4, 
#                     y = fixedeffect_intercept + fixedeffect_slope*-4, yend = fixedeffect_intercept + fixedeffect_slope*4), # size = 2,  color = "black") +


plot_model(confirmatory2,type = "pred", terms = "PDS_score", 
           show.data = TRUE, jitter = 0.1, line.size = 2) +
   ylab("Internalizing Score") +
   xlab("PDS Stage") +
   scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(30,100)) +
   theme(title= element_text(size=26, vjust=2, face="bold"),
         plot.title = element_blank(),
         axis.title.x= element_text(size=18, vjust=-0.3),
         axis.title.y= element_text(size=18, vjust=1.5),
         axis.text.x= element_text(size=18, colour="black"),
         axis.text.y= element_text(size=18, colour="black"),
         legend.position="none",
         strip.text = element_text(size=24, face="bold"),
         panel.background = element_blank(),
         axis.line = element_line(colour = "black"))


# Are there gender differences in this effect?

confirmatory2_gender <- lmer(cbcl_scr_syn_internal_r ~ PDS_score*sex +
                      race.ethnicity.5level +
                      high.educ +
                      household.income +
                      married.or.livingtogether +
                      interview_age +
                      demo_race_hispanic +
                      (1 | site_id_l/rel_family_id),
                      data = PDS_correct)
summary(confirmatory2_gender)

plot_model(confirmatory2_gender,type = "int", terms = "PDS_score", 
           show.data = TRUE, jitter = 0.1, line.size = 2) +
   ylab("Internalizing Score") +
   xlab("PDS Stage") +
   scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(30,100)) +
   theme(title= element_text(size=26, vjust=2, face="bold"),
         plot.title = element_blank(),
         axis.title.x= element_text(size=18, vjust=-0.3),
         axis.title.y= element_text(size=18, vjust=1.5),
         axis.text.x= element_text(size=18, colour="black"),
         axis.text.y= element_text(size=18, colour="black"),
         #legend.position="none",
         strip.text = element_text(size=24, face="bold"),
         panel.background = element_blank(),
         axis.line = element_line(colour = "black"))
```


```{r Confirmatory2, echo = FALSE}
# Plot with raw scores to get an idea.
# Flux poster

confirmatory2_gender_CBCLrawscore <- lmer(cbcl_scr_syn_internal_r ~ PDS_score*sex +
                      race.ethnicity.5level +
                      high.educ +
                      household.income +
                      married.or.livingtogether +
                      interview_age +
                      demo_race_hispanic +
                      #fam_history_q6d_depression + #added mother's depression
                      (1 | site_id_l/rel_family_id),
                      data = PDS_correct)
summary(confirmatory2_gender_CBCLrawscore)

plot_model(confirmatory2_gender_CBCLrawscore,type = "est", show.data = FALSE) #Forest plot

plot_model(confirmatory2_gender_CBCLrawscore,type = "int", terms = "PDS_score", 
           show.data = TRUE, jitter = 0.1, line.size = 2) +
   ylab("Internalizing Score") +
   xlab("PDS Stage") +
   #scale_y_continuous(breaks = seq(0, 100, by = 10), limits = c(30,100)) +
   theme(title= element_text(size=26, vjust=2, face="bold"),
         plot.title = element_blank(),
         axis.title.x= element_text(size=18, vjust=-0.3),
         axis.title.y= element_text(size=18, vjust=1.5),
         axis.text.x= element_text(size=18, colour="black"),
         axis.text.y= element_text(size=18, colour="black"),
         #legend.position="none",
         strip.text = element_text(size=24, face="bold"),
         panel.background = element_blank(),
         axis.line = element_line(colour = "black"))

file.name = (here("output","question2_exploratorysample.tiff"))
ggsave(file.name,plot = last_plot(), dpi = 150, device = "tiff")


# Male Category pds_p_m_cat_sum (sum_p_m):
# 1: prepuberty; sum_p_m = 3.
# 2: early puberty; sum_p_m >= 4 and <= 5.
# 3: mid puberty; sum_p_m >= 6 and <= 8.
# 4: late puberty; sum_p_m >= 9 and <= 11.
# 5: post puberty; sum_p_m = 12.


# Female Category:
# 1: prepuberty; sum_p_f = 2 and pds_f5_p = 1.
# 2: early puberty; sum_p_f = 3 and pds_f5_p = 1.
# 3: mid puberty; sum_p_f >= 3 and pds_f5_p = 1.
# 4: late puberty; sum_p_f <= 7 and pds_f5_p = 4.
# 5: post puberty; sum_p_f = 8 and pds_f5_p = 4.

# To compute Puberty Category Scores for boys use body hair growth, voice change, and facial hair growth as follows:
# Prepubertal = 3.
# Early Pubertal = 4 or 5 (no 3-point responses).
# Midpubertal = 6, 7, or 8 (no 4-points).
# Late pubertal = 9-11.
# Postpubertal = 12.
# 
# 
# To compute Puberty Category Scores for girls use body hair growth, breast development, and menarche as follows:
# Prepubertal = 2 and no menarche.
# Early Puberty = 3 and no menarche.
# Midpubertal = > 3 and no menarche.
# Late Puberty = <= 7 and menarche.
# Postpubertal = 8 and menarche.


pubescent <- subset(PDS_correct, PDS_score > 1) # This isn't right because PDS_score is continuous (not these exact numbers).
```


# Exploratory Hypothesis 2: We will investigate whether testosterone relates to internalizing symptoms and whether this relationship is present after controlling for PDS.
## Model A: CBCL internalizing factor ~ Testosterone
```{r Exploratory2A, echo = FALSE}
# Get an idea of the sample.

mean(PDS_correct$hormone_scr_ert_mean_z,na.rm= TRUE) # 5.00.
mean(females$hormone_scr_ert_mean_z,na.rm= TRUE) # 4.97
mean(males$hormone_scr_ert_mean_z,na.rm= TRUE) # 5.03.
min(females$hormone_scr_ert_mean_z,na.rm= TRUE) # 0.
min(males$hormone_scr_ert_mean_z,na.rm= TRUE) # 30.
t.test(males$hormone_scr_ert_mean_z,females$hormone_scr_ert_mean_z) # Not significant.


confirmatory2_testosterone_CBCL <- lmer(cbcl_scr_syn_internal_r ~ hormone_scr_ert_mean_z +
                      race.ethnicity.5level +
                      high.educ +
                      household.income +
                      married.or.livingtogether +
                      interview_age +
                      demo_race_hispanic +
                      #fam_history_q6d_depression + #added mother's depression
                      (1 | site_id_l/rel_family_id),
                      data = PDS_correct)
summary(confirmatory2_testosterone_CBCL)

```

## Model B: CBCL internalizing factor ~ Testosterone + Pubertal stage 
```{r Exploratory2B, echo = FALSE}


```
