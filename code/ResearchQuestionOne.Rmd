---
title: "Research Question 1: Research Question 1: Does pubertal development relate to neural and behavioral responses to reward?"
date: "August 2020"
output:
  html_document: default
  pdf_document: default
authors: Natalie Saragosa-Harris 
---
``` {r loadPackages, echo = FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(gamm4)
library(dplyr)
library(sjPlot)
library(here)
```

```{r setdirectories, echo = FALSE}
# Change this to your directory and the name of your data file.
datapath <- "/Users/nataliesaragosa-harris/Desktop/ABCD/output"
datafile <- "nda20_exploratory.csv"
setwd(datapath)

# Covariates.
#      Random effects.
#           1. Family. (rel_family_id) # Make sure this is nested correctly and looks about right.
#           2. Site. (site_id_l)
#           3. Subject. (src_subject_id) # There is only one timepoint so we cannot do a random effect for each participant.
#           4. Device. # mri_info_deviceserialnumber.

          #  Random effects are nested: (1|abcd_site/device/rel_family_id) [unless some siblings went in different scanners?]

#      Fixed effects.
#           1. Race parent. (race.ethnicity.5level).
#           2. Education parent. (high.educ).
#           3. Income parent. (household.income)
#           4. Marital status parent. (married.or.livingtogether)
#           5. Age. (interview_age).
#           6. Hispanic. (demo_race_hispanic).

```

```{r settheme, echo = FALSE}
nsh_theme <- theme(title= element_text(size=26, vjust=2, face="bold"),
         plot.title = element_blank(),
         axis.title.x= element_text(size=18, vjust=-0.3),
         axis.title.y= element_text(size=18, vjust=1.5),
         axis.text.x= element_text(size=18, colour="black"),
         axis.text.y= element_text(size=18, colour="black"),
         strip.text = element_text(size=24, face="bold"),
         panel.background = element_blank(),
         axis.line = element_line(colour = "black"))

```

```{r GetData, echo = FALSE}
#LMW alternative to read in the data

data_dir = ((dirname(here()))) 

phase_folder = "exploratory"  #select the appropiate folder
#phase_folder = "confirmatory"  #select the appropiate folder

data_folder <- file.path(data_dir,"ABCD","derivatives",phase_folder)  

file_name <- "nda20_exploratory.csv" #specify file name here 

fulldata <- read.csv(file.path(data_folder,file_name))
length(fulldata$src_subject_id) # 5934.

data <- fulldata[,c("src_subject_id",
                "interview_age",
                "eventname",
                "sex",
                "site_id_l",
                "mri_info_deviceserialnumber",
                "rel_family_id",
                "race.ethnicity.5level",
                "race.eth.7level",
                "demo_race_hispanic", # Do you consider the child Hispanic/Latino/Latina?
                "high.educ",
                "household.income",
                "married.or.livingtogether",
                "bisbas_ss_basm_rr",
                "cbcl_scr_syn_internal_t",
                "cbcl_scr_syn_anxdep_t",
                "cbcl_scr_syn_withdep_t",
                "cbcl_scr_dsm5_depress_t",
                "cbcl_scr_syn_internal_r",
                "cbcl_scr_syn_anxdep_r",
                "cbcl_scr_syn_withdep_r",
                "cbcl_scr_dsm5_depress_r",
                "PDS_score_f",
                "PDS_score_m",
                "PDS_score",
                "PDS_sum_f",
                "PDS_sum_m",
                "PDS_sum",
                "pds_p_ss_category",
                "fam_history_q6d_depression",
                "tfmri_ma_acdn_b_scs_aarh", # Accumbens reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_aalh",
                "tfmri_ma_acdn_b_scs_cdrh", # Caudate reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_cdlh",
                "tfmri_ma_acdn_b_scs_ptrh", # Putamen reward vs. neutral anticipation.
                "tfmri_ma_acdn_b_scs_ptlh",
                "tfmri_ma_arvn_b_cds_mobofrrh", # Medial OFC reward vs. neutral anticipation.
                "tfmri_ma_arvn_b_cds_mobofrlh",
                "tfmri_ma_arvn_b_cds_lobofrrh", # Lateral OFC reward vs. neutral anticipation.
                "tfmri_ma_arvn_b_cds_lobofrlh",
                "tfmri_ma_rpvnfb_b_scs_aarh", # Accumbens reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_aalh",
                "tfmri_ma_rpvnfb_b_scs_cdrh", # Caudate reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_cdlh",
                "tfmri_ma_rpvnfb_b_scs_ptrh", # Putamen reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_scs_ptlh",
                "tfmri_ma_rpvnfb_b_cds_mobofrrh", # Medial OFC reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_cds_mobofrlh",
                "tfmri_ma_rpvnfb_b_cds_lobofrrh", # Lateral OFC reward positive versus negative feedback.
                "tfmri_ma_rpvnfb_b_cds_lobofrlh",
                "accumbens_rvsn_ant_z", # Reward vs. neutral during anticipation stage (z scores).
                "caudate_rvsn_ant_z",
                "putamen_rvsn_ant_z",
                "mOFC_rvsn_ant_z",
                "lOFC_rvsn_ant_z",
                "striatum_rvsn_ant_z", # reward vs. neutral anticipation.
                "accumbens_posvsneg_feedback_z", # All positive vs. negative feedback.
                "caudate_posvsneg_feedback_z",
                "putamen_posvsneg_feedback_z",
                "mOFC_posvsneg_feedback_z",
                "lOFC_posvsneg_feedback_z",
                "striatum_posvsneg_feedback_z"
                )]

data$src_subject_id <- as.factor(data$src_subject_id)
data$rel_family_id <- as.factor(data$rel_family_id)
data$eventname <- as.factor(data$eventname)
data$sex <- as.factor(data$sex)
data$demo_race_hispanic <- as.factor(data$demo_race_hispanic)
data$site_id_l <- as.factor(data$site_id_l)
data$mri_info_deviceserialnumber <- as.factor(data$mri_info_deviceserialnumber)
data$race.eth.7level <- as.factor(data$race.eth.7level)
data$high.educ <- as.factor(data$high.educ)
data$household.income <- as.factor(data$household.income)
data$married.or.livingtogether <- as.factor(data$married.or.livingtogether)
data$pds_p_ss_category <-as.factor(data$pds_p_ss_category)
data$race.ethnicity.5level = data$race.eth.7level
data$race.ethnicity.5level[(data$race.eth.7level == "AIAN" | data$race.eth.7level == "NHPI")] = "Other"
data$race.ethnicity.5level = droplevels(data$race.ethnicity.5level)

data$PDS_score_z<- scale(data$PDS_score)
data$cbcl_scr_syn_internal_r_z <- scale(data$cbcl_scr_syn_internal_r)

length(data$src_subject_id) # 5934.

# Use data with only correct PDS scores.
PDS_correct <- subset(data, PDS_score < 5) #Be mindful that PDS category goes from 1 to 5, while PDS_average goes from 1 to 4 (continuous).
length(PDS_correct$src_subject_id) # 4224.

# Separate by sex.
PDS_correct_females <- subset(PDS_correct, sex == "F") # 2059.
PDS_correct_males <- subset(PDS_correct, sex == "M") # 2165.
length(PDS_correct_females$src_subject_id)
length(PDS_correct_males$src_subject_id)

# Create different subsets of the data based on removing outliers for specific variables of interest.
# No CBCL outliers.
data_no_CBCL_outliers <- subset(PDS_correct, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers$src_subject_id) # 4152.

data_no_CBCL_outliers_females<- subset(PDS_correct_females, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers_females$src_subject_id) # 2026.

data_no_CBCL_outliers_males<- subset(PDS_correct_males, cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_outliers_males$src_subject_id) # 2126.

# No striatal anticipation outliers.
data_no_striatal_ant_outliers <- subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers$src_subject_id) # 4169.

data_no_striatal_ant_outliers_females <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers_females$src_subject_id) # 2035.

data_no_striatal_ant_outliers_males <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3)
length(data_no_striatal_ant_outliers_males$src_subject_id) # 2134.

# No CBCL or striatal anticipation outliers.
data_no_CBCL_striatal_ant_outliers <- subset(PDS_correct, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers$src_subject_id) # 4097.

data_no_CBCL_striatal_ant_outliers_females <- subset(PDS_correct_females, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers_females$src_subject_id) # 2002.

data_no_CBCL_striatal_ant_outliers_males <- subset(PDS_correct_males, striatum_rvsn_ant_z > -3 & striatum_rvsn_ant_z < 3 & cbcl_scr_syn_internal_r_z > -3 & cbcl_scr_syn_internal_r_z < 3)
length(data_no_CBCL_striatal_ant_outliers_males$src_subject_id) # 2095.


```

# Confirmatory Hypothesis 1: We hypothesize that pubertal stage will be associated with neural response to reward during a monetary incentive delay task (Braams et al., 2015). In particular, we expect heightened striatal activation during reward anticipation for more advanced pubertal stages.
## Model: Striatal activation (anticipation stage) ~ Pubertal stage
```{r Confirmatory1, echo = FALSE}
confirmatory1_females <- lmer(striatum_rvsn_ant_z ~ PDS_score +
                      race.ethnicity.5level +
                      high.educ +
                      household.income +
                      married.or.livingtogether +
                      interview_age +
                      demo_race_hispanic, +
                      (1 | site_id_l/rel_family_id),
                      data = data_no_striatal_ant_outliers_females)
summary(confirmatory1_females) # Singularity problem?
plot_model(confirmatory1_females,type = "pred", terms = "PDS_score", show.data = FALSE)

plot_model(confirmatory1_females,type = "est", show.data = FALSE) # forest plot.


```
# Exploratory Hypothesis 1A: We will explore whether striatal activation during reward feedback is related to pubertal stage.
## Model: Striatal activation (feedback stage) ~ Pubertal stage 
```{r Exploratory1A, echo = FALSE}

```
# Exploratory Hypothesis 1B: We hypothesize that more advanced pubertal stages will be associated with greater self-reported reward responsiveness (BAS - RR) (Harden et al. 2018).
## Model: BIS-BAS-RR ~ Pubertal stage
```{r Exploratory1B, echo = FALSE}

```
# Exploratory Hypothesis 1C: We hypothesize that greater pubertal stage will be associated with greater behavioral reactivity to reward (i.e., reaction time on reward vs. neutral trials).
## Model: Reaction Time ~ Pubertal Stage
```{r Exploratory1C, echo = FALSE}

```
# Exploratory Hypothesis 1D: We hypothesize that testosterone will be positively associated with our indicators of reward (neural activity, behavioral reaction time, and self-reported reward responsiveness).
## Model A: Striatal activation (anticipation stage) ~ Testosterone
## Model B: Striatal activation (feedback stage) ~ Testosterone
## Model C: OFC activation (anticipation stage) ~ Testosterone
## Model D: OFC activation (feedback stage) ~ Testosterone
## Model E: MID Reaction Time ~ Testosterone
## Model F: BIS-BAS-RR ~ Testosterone
```{r Exploratory1D, echo = FALSE}

```