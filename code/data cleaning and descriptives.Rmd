---
title: "ABCD depression puberty reward - Exploratory - Demographics and behavioral data description and cleaning"
date: "date started 01/july/20"
output:
  html_document: default
  pdf_document: default
authors: Lucia Magis Weinberg, Natalie Saragosa-Harris
---

```{LoadPackages, include=FALSE}
# Load packages.
#install.packages("devtools")
#devtools::install_github("easystats/report")
#devtools::install_github("goodekat/ggResidpanel")
#library(ggResidpanel)
#library(report)
packages <- c("tidyverse",   #data wrangling
             # "summarytools",  #data exploration and simple reporting
              "psych",          #correlations and Cronbach alpha for internal consistency  
              "readr",          #read csv
              "tidyr",          #create tidy data, where every column is a variable, every row is an observation 
              "dplyr",          #selecting columns, mutating, summarizing, etc.
              "Hmisc",          #correlations
              "RColorBrewer",   #choose nice colors for graphs
              "psychotools",    #psychometric modeling
              "knitr",          #Produce Rmarkdowns from Rnotebooks
              "lme4",           #run mixed effects regressions
              "lmerTest",       #compare different mixed effects models  
              "car",            #Companion to Applied Regression
              "haven",          #Import foreign statistical formats into R   
              "jtools",         #plot interactions 
              "apaTables",      #produce tables, might be redundant
              "DataExplorer",   #data exploration
              "interactions",   #interactions
              "ggstatsplot",    #pretty plots
              "ggplot2",        #other pretty plots
              "here",)           #file navigation within a project
#library("conflicted") #only run when there are issues with functions. Will illuminate which functions come from different packages
#invisible(lapply(packages, install.packages, character.only = TRUE)) #Only run once to install packages
library(tidyverse)
library(ggstatsplot)
invisible(lapply(packages, library, character.only = TRUE))


# needed package to download from GitHub repo
#install.packages("remotes")
library(remotes)
# downloading the package from GitHub (needs `remotes` package to be installed)
remotes::install_github(
  repo = "IndrajeetPatil/ggstatsplot", # package path on GitHub
  dependencies = FALSE, # assumes you have already installed needed packages
  quick = TRUE # skips docs, demos, and vignettes
)
```

```{GetData, include=FALSE}
# Load data.
## This script assumes that data has already been named and split into two halves.
## This script is based on the variable names on VariableDefinitions.csv

data_dir = ((dirname(here()))) #figure out how to navigate to data source

phase_folder = "exploratory"  #select the appropiate folder
#phase_folder = "confirmatory"  #select the appropiate folder

data_folder <- file.path(data_dir,"ABCD","derivatives",phase_folder)

file_name <- "nda20_exploratory.csv" #specify file name here 

fulldata <- read.csv(file.path(data_folder,file_name))
#as_tibble(fulldata)
nrow(fulldata) # 5934.

```

```{r CreateDataframes, echo = FALSE}
# Call the script that keeps the columns of interest in the data and creates data frames that exclude outliers for certain variables.
script_dir = ((dirname(here()))) #figure out how to navigate to data source
phase_folder = "exploratory"  #select the appropiate folder
#phase_folder = "confirmatory"  #select the appropiate folder
script_folder <- file.path(script_dir,"ABCD","derivatives",phase_folder)
#script_folder <- "/Users/nataliesaragosa-harris/Desktop/ABCD/rewardprocesses_internalizing_puberty_exploratory/code/"
source(file.path(script_folder,"define_dataframes.R")) # Now, all of your different data frames should be loaded!

```

```{r settheme, echo = FALSE}
nsh_theme <- theme(title= element_text(size=26, vjust=2, face="bold"),
         plot.title = element_blank(),
         axis.title.x= element_text(size=18, vjust=-0.3),
         axis.title.y= element_text(size=18, vjust=1.5),
         axis.text.x= element_text(size=18, colour="black"),
         axis.text.y= element_text(size=18, colour="black"),
         strip.text = element_text(size=24, face="bold"),
         panel.background = element_blank(),
         axis.line = element_line(colour = "black"))

```

```{r SummarizeDataFrame, echo = FALSE}
# Summarize everything except the individual level variables (like participant ID, site, etc.).
summarizing_dataframe <- PDS_correct %>% select(-c("src_subject_id",
                                         "site_id_l",
                                         "mri_info_deviceserialnumber",
                                         "rel_family_id"))

View(summary(summarizing_dataframe))

# Create data tables for each subject of interest (PDS, brain measures, etc.).
# Note: For the MRI variables, I am ignoring the right and left hemisphere variables and only using the combined ones for now.

# All reward vs. neutral during anticipation stage (z scores).
MRI_anticipation_stage <- PDS_correct[,c("src_subject_id",
                    "interview_age",
                    "eventname",
                    "sex",
                    "accumbens_rvsn_ant_z",
                    "caudate_rvsn_ant_z",
                    "putamen_rvsn_ant_z",
                    "mOFC_rvsn_ant_z",
                    "lOFC_rvsn_ant_z",
                    "striatum_rvsn_ant_z")]

attach(MRI_anticipation_stage)
MRI_anticipation_stage_summary <- list("Accumbens" =
       list("min"       = ~ min(accumbens_rvsn_ant_z, na_rm = TRUE),
            "max"       = ~ max(accumbens_rvsn_ant_z, na_rm = TRUE),
            "mean (sd)" = ~ qwraps2::mean_sd(accumbens_rvsn_ant_z, na_rm = TRUE)),
       "Caudate" =
       list("min"       = ~ min(caudate_rvsn_ant_z, na_rm = TRUE),
            "median"    = ~ median(caudate_rvsn_ant_z, na_rm = TRUE),
            "max"       = ~ max(caudate_rvsn_ant_z, na_rm = TRUE),
            "mean (sd)" = ~ qwraps2::mean_sd(caudate_rvsn_ant_z, na_rm = TRUE)),
       "Putamen" =
       list("min"       = ~ min(putamen_rvsn_ant_z, na_rm = TRUE),
            "max"       = ~ max(putamen_rvsn_ant_z, na_rm = TRUE),
            "mean (sd)" = ~ qwraps2::mean_sd(putamen_rvsn_ant_z, na_rm = TRUE)),
       "Striatum (Combined Areas)" =
       list("min"       = ~ min(striatum_rvsn_ant_z, na_rm = TRUE),
            "max"       = ~ max(striatum_rvsn_ant_z, na_rm = TRUE),
            "mean (sd)" = ~ qwraps2::mean_sd(striatum_rvsn_ant_z, na_rm = TRUE)),
       "Medial OFC" =
        list("min"       = ~ min(mOFC_rvsn_ant_z, na_rm = TRUE),
            "max"       = ~ max(mOFC_rvsn_ant_z, na_rm = TRUE),
            "mean (sd)" = ~ qwraps2::mean_sd(mOFC_rvsn_ant_z, na_rm = TRUE)),
       "Lateral OFC" =
        list("min"       = ~ min(lOFC_rvsn_ant_z, na_rm = TRUE),
            "max"       = ~ max(lOFC_rvsn_ant_z, na_rm = TRUE),
            "mean (sd)" = ~ qwraps2::mean_sd(lOFC_rvsn_ant_z, na_rm = TRUE))
       )

x <- summary_table(MRI_anticipation_stage, MRI_anticipation_stage_summary)
x

# All positive vs. negative feedback.
MRI_feedback_stage <- PDS_correct[,c("src_subject_id",
                    "interview_age",
                    "eventname",
                    "sex",
                    "accumbens_posvsneg_feedback_z", 
                    "caudate_posvsneg_feedback_z",
                    "putamen_posvsneg_feedback_z",
                    "mOFC_posvsneg_feedback_z",
                    "lOFC_posvsneg_feedback_z",
                    "striatum_posvsneg_feedback_z")]


```

```{TestosteroneDistributions}
PDS_correct$ERT_Hormone_Rounded <- floor(PDS_correct$hormone_scr_ert_mean) # I used the floor function to round down testosterone levels to a whole number. This creates a new variable (and so a new column), Testosterone_Rounded, in my dataframe (PDS_correct.
#PDS_correct$DHEA_Hormone_Rounded <- floor(PDS_correct$hormone_scr_dhea_mean) # DHEA
#PDS_correct$HSE_Hormone_Rounded <- floor(PDS_correct$hormone_scr_hse_mean) # Estrogen, only for women

# Example distribution: Plot testosterone levels (rounded down) in the sample.
max_level <- max(PDS_correct$ERT_Hormone_Rounded,na.rm = TRUE)
min_level <- min(PDS_correct$ERT_Hormone_Rounded,na.rm = TRUE)
total_plot <- ggplot(PDS_correct, aes(x=ERT_Hormone_Rounded)) + # this line is saying plot my data (PDS_correct), with the x axis being their rounded testosterone.
              geom_histogram(binwidth=0.5,alpha= 0.8) + # this is specifying the width of the histogram bars and how transparent the color is (that is the alpha).
              scale_x_continuous(breaks=c(seq(min_level, max_level, by=5))) + # include mininum to maximum observed values on the axis and to plot by intervals of 5.
              labs(title = "Testosterone Levels by sex (Exploratory sample)",x = "Testosterone") + # Set the title of the graph and label the x axis.
facet_grid(. ~ sex)
total_plot
```

```{TestosteroneByGroup}
p <- ggplot(PDS_correct, aes(x=sex, y=ERT_Hormone_Rounded)) + 
  geom_boxplot()
p
```

```{BehavioralRewardDistributions}
# Example distribution: Plot BIS/BAS RR in the sample.
max_level <- max(PDS_correct$bisbas_ss_basm_rr,na.rm = TRUE)
min_level <- min(PDS_correct$bisbas_ss_basm_rr,na.rm = TRUE)
total_plot <- ggplot(PDS_correct, aes(x=bisbas_ss_basm_rr)) + # this line is saying plot my data (PDS_correct), with the x axis being their rounded testosterone.
              geom_histogram(binwidth=.5,alpha= 0.8) + # this is specifying the width of the histogram bars and how transparent the color is (that is the alpha).
              scale_x_continuous(breaks=c(seq(min_level, max_level, by=10))) + # include mininum to maximum observed values on the axis and to plot by intervals of 5.
              labs(title = "Reward responsiveness by sex (Exploratory sample)",x = "BIS/BAS RR")+ # Set the title of the graph and label the x axis.
facet_grid(. ~ sex)
total_plot
```

```{BehavioralRewardByGroup}
p <- ggplot(PDS_correct, aes(x=sex, y=bisbas_ss_basm_rr)) + 
  geom_boxplot()
p
```

```{BehavioralRewardByGender}
#RR by gender
p <- ggbetweenstats(
  data = PDS_correct,
  x = sex, # > 2 groups
  y = bisbas_ss_basm_rr,
  xlab = "Sex",
  ylab = "BIS/BAS RR score",
  title = "Reward responsiveness by sex",
  bf.message  = FALSE,
  pairwise.display = "significant", # display only significant pairwise comparisons
  pairwise.annotation = "p.value", # annotate the pairwise comparisons using p-values
  p.adjust.method = "fdr", # adjust p-values for multiple tests using this method
  messages = FALSE,
  palette = "Set2",
  package = "RColorBrewer",
  ggstatsplot.layer = FALSE,
  ggplot.component = list(theme(axis.text.y= element_text(size = 14,face="bold"),
                                axis.text.x = element_text(size = 14,face="bold"),
                                axis.title.x = element_text(size = 16,face="bold"),
                                axis.title.y = element_text(size = 16,face="bold"),
                                plot.subtitle = element_text(size = 12),
                                title =element_text(size=18, face='bold')))
)

p
```

```{CBCLDistributions}
# Example distribution: Plot CBCL (rounded down) in the sample.
max_level <- max(PDS_correct$cbcl_scr_syn_internal_r,na.rm = TRUE)
min_level <- min(PDS_correct$cbcl_scr_syn_internal_r,na.rm = TRUE)
total_plot <- ggplot(PDS_correct, aes(x=cbcl_scr_syn_internal_r)) +
              geom_histogram(binwidth=.5,alpha= 0.8) + # this is specifying the width of the histogram bars and how transparent the color is (that is the alpha).
              scale_x_continuous(breaks=c(seq(min_level, max_level, by=10))) + # include mininum to maximum observed values on the axis and to plot by intervals of 5.
              labs(title = "CBCL Internalizing symptoms by sex (Exploratory sample)",x = "cbcl_scr_syn_internal_t") + # Set the title of the graph and label the x axis. 
facet_grid(. ~ sex)
total_plot
```

```{CBCLByGroup}
p <- ggplot(PDS_correct, aes(x=sex, y=cbcl_scr_syn_internal_t)) + 
  geom_boxplot()
p
```

```{CBCLWithDepressionDistributions}
# Example distribution: Plot CBCL (rounded down) in the sample.
max_level <- max(PDS_correct$cbcl_scr_syn_withdep_t,na.rm = TRUE)
min_level <- min(PDS_correct$cbcl_scr_syn_withdep_t,na.rm = TRUE)
total_plot <- ggplot(PDS_correct, aes(x=cbcl_scr_syn_withdep_t)) + # this line is saying plot my data (PDS_correct), with the x axis being their rounded testosterone.
              geom_histogram(binwidth=.5,alpha= 0.8) + # this is specifying the width of the histogram bars and how transparent the color is (that is the alpha).
              scale_x_continuous(breaks=c(seq(min_level, max_level, by=10))) + # include mininum to maximum observed values on the axis and to plot by intervals of 5.
              labs(title = "CBCL withdrawn depression symptoms by sex (Exploratory sample)",x = "CBCL_scr_syn_withdep_t") +# Set the title of the graph and label the x axis.
facet_grid(. ~ sex)
total_plot
```

```{CBCLWithDepressionByGroup}
p <- ggplot(PDS_correct, aes(x=sex, y=cbcl_scr_syn_withdep_t)) + 
  geom_boxplot()
p
```

```{CBCLWithDepressionByGender}
#Withdrawn depression by gender
p <- ggbetweenstats(
  data = PDS_correct,
  x = sex, # > 2 groups
  y = cbcl_scr_syn_internal_r,
  xlab = "Sex",
  ylab = "CBCL internalizing symptoms",
  title = "Withdrawn depressive symptoms by sex (Exploratory sample)",
  bf.message  = FALSE,
  pairwise.display = "significant", # display only significant pairwise comparisons
  pairwise.annotation = "p.value", # annotate the pairwise comparisons using p-values
  p.adjust.method = "fdr", # adjust p-values for multiple tests using this method
  messages = FALSE,
  palette = "Set2",
  package = "RColorBrewer",
  ggstatsplot.layer = FALSE,
  ggplot.component = list(theme(axis.text.y= element_text(size = 14,face="bold"),
                                axis.text.x = element_text(size = 14,face="bold"),
                                axis.title.x = element_text(size = 16,face="bold"),
                                axis.title.y = element_text(size = 16,face="bold"),
                                plot.subtitle = element_text(size = 12),
                                title =element_text(size=18, face='bold')))
)

p
```

```{r}
#Depression by gender
p <- ggbetweenstats(
  data = PDS_correct,
  x = sex, # > 2 groups
  y = cbcl_scr_syn_internal_r,
  xlab = "Sex",
  ylab = "CBCL internalizing score",
  title = "Internalizing symptoms by sex",
  bf.message  = FALSE,
  pairwise.display = "significant", # display only significant pairwise comparisons
  pairwise.annotation = "p.value", # annotate the pairwise comparisons using p-values
  p.adjust.method = "fdr", # adjust p-values for multiple tests using this method
  messages = FALSE,
  palette = "Set2",
  package = "RColorBrewer",
  ggstatsplot.layer = FALSE,
  ggplot.component = list(theme(axis.text.y= element_text(size = 14,face="bold"),
                                axis.text.x = element_text(size = 14,face="bold"),
                                axis.title.x = element_text(size = 16,face="bold"),
                                axis.title.y = element_text(size = 16,face="bold"),
                                plot.subtitle = element_text(size = 12),
                                title =element_text(size=18, face='bold')))
)

p
#file.name = (here("output","peru2_depression_gender.tiff"))
#ggsave(file.name,plot = last_plot(), dpi = 100, device = "tiff")
```

```{r}
#Depression by gender
p <- ggbetweenstats(
  data = PDS_correct,
  x = sex, # > 2 groups
  y = cbcl_scr_syn_withdep_t,
  xlab = "Sex",
  ylab = "CBCL depression score",
  title = "Depressive symptoms by sex (Exploratory sample)",
  bf.message  = FALSE,
  pairwise.display = "significant", # display only significant pairwise comparisons
  pairwise.annotation = "p.value", # annotate the pairwise comparisons using p-values
  p.adjust.method = "fdr", # adjust p-values for multiple tests using this method
  messages = FALSE,
  palette = "Set2",
  package = "RColorBrewer",
  ggstatsplot.layer = FALSE,
  ggplot.component = list(theme(axis.text.y= element_text(size = 14,face="bold"),
                                axis.text.x = element_text(size = 14,face="bold"),
                                axis.title.x = element_text(size = 16,face="bold"),
                                axis.title.y = element_text(size = 16,face="bold"),
                                plot.subtitle = element_text(size = 12),
                                title =element_text(size=18, face='bold')))
)

p
```


```{PDSScoreDistributions}
# Plot PDS_score in the sample.
p <-  ggplot(PDS_correct, aes(PDS_score, ..count..)) + geom_bar(position = "dodge") + facet_grid(. ~ sex)
p

```

```{PDSScoreByGender}
#PDS score by gender
p <- ggbetweenstats(
  data = PDS_correct,
  x = sex, # > 2 groups
  y = PDS_score_both,
  xlab = "Sex",
  ylab = "PDS",
  title = "PDS by sex (Exploratory sample)",
  bf.message  = FALSE,
  pairwise.display = "significant", # display only significant pairwise comparisons
  pairwise.annotation = "p.value", # annotate the pairwise comparisons using p-values
  p.adjust.method = "fdr", # adjust p-values for multiple tests using this method
  messages = FALSE,
  palette = "Set2",
  package = "RColorBrewer",
  ggstatsplot.layer = FALSE,
  ggplot.component = list(theme(axis.text.y= element_text(size = 14,face="bold"),
                                axis.text.x = element_text(size = 14,face="bold"),
                                axis.title.x = element_text(size = 16,face="bold"),
                                axis.title.y = element_text(size = 16,face="bold"),
                                plot.subtitle = element_text(size = 12),
                                title =element_text(size=18, face='bold')))
)

p
#file.name = (here("output","peru2_depression_gender.tiff"))
#ggsave(file.name,plot = last_plot(), dpi = 100, device = "tiff")
```

```{r}
#PDS score by gender
p <- ggbetweenstats(
  data = PDS_correct,
  x = race.eth.8level, # > 2 groups
  y = PDS_score_both,
  xlab = "Race/ethnicity",
  ylab = "PDS",
  grouping.var = sex,
  title = "PDS by race/ethnicity (Exploratory sample)",
  bf.message  = FALSE,
  pairwise.display = "significant", # display only significant pairwise comparisons
  pairwise.annotation = "p.value", # annotate the pairwise comparisons using p-values
  p.adjust.method = "fdr", # adjust p-values for multiple tests using this method
  messages = FALSE,
  palette = "Set2",
  package = "RColorBrewer",
  ggstatsplot.layer = FALSE,
  ggplot.component = list(theme(axis.text.y= element_text(size = 14,face="bold"),
                                axis.text.x = element_text(size = 14,face="bold"),
                                axis.title.x = element_text(size = 16,face="bold"),
                                axis.title.y = element_text(size = 16,face="bold"),
                                plot.subtitle = element_text(size = 12),
                                title =element_text(size=18, face='bold')))
)

p 

```

```{PubertalCategory}
p <-  ggplot(PDS_correct, aes(pds_p_ss_category, ..count..)) + geom_bar(aes(fill = sex), position = "dodge")
p
```

#Brain
```{StriatumAnticipationDistributions}

max_level <- max(PDS_correct$striatum_rvsn_ant_z,na.rm = TRUE)
min_level <- min(PDS_correct$striatum_rvsn_ant_z,na.rm = TRUE)
total_plot <- ggplot(PDS_correct, aes(x=striatum_rvsn_ant_z)) +
              geom_histogram(binwidth=.5,alpha= 0.8) +
              scale_x_continuous(breaks=c(seq(min_level, max_level, by=10))) +
              labs(title = "Striatal activity during reward anticipation by sex (Exploratory sample)",x = "striatum_rvsn_ant_z") +
              facet_grid(. ~ sex)
total_plot
```

```{StriatumAnticipationByGroup}
p <- ggplot(PDS_correct, aes(x=sex, y=striatum_rvsn_ant_z)) + 
  geom_boxplot() + labs(title = "Striatal activity during reward anticipation by sex (Exploratory sample)",x = "striatum_rvsn_ant")

p
```